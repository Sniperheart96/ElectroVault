# Internationalisierung (i18n)

> Mehrsprachigkeit in ElectroVault

## Grundprinzipien

1. **Mindestens eine Sprache** - Jedes lokalisierte Feld braucht mindestens einen Wert (egal welche Sprache)
2. **Fallback-Kette** - Angefragte Sprache → Englisch → Erste verfügbare Sprache
3. **Alle Freitextfelder sind mehrsprachig** - Jede Nutzereingabe wird pro Sprache erfasst
4. **UI und Content getrennt** - UI-Texte via next-intl, DB-Inhalte via JSON-Felder
5. **Keine Zwangsübersetzung** - Deutsche Nutzer können rein deutsche Inhalte erstellen

---

## Unterstützte Sprachen

| Code | Sprache | Bemerkung |
|------|---------|-----------|
| `en` | English | Bevorzugter Fallback |
| `de` | Deutsch | Primäre Sprache |
| `fr` | Français | - |
| `es` | Español | - |
| `zh` | 中文 | - |

> **Erweiterbar:** Neue Sprachen können jederzeit hinzugefügt werden, da JSON-Struktur flexibel ist.

---

## Technische Umsetzung

### LocalizedString Type

Alle Freitextfelder werden als JSON gespeichert:

```typescript
type LocalizedString = {
  en?: string;
  de?: string;
  fr?: string;
  es?: string;
  zh?: string;
  [locale: string]: string | undefined;
};

// Beispiel: Nur deutsche Beschreibung
{ "de": "Präzisions-Timer-IC" }

// Beispiel: Mehrsprachig
{
  "en": "Precision Timer IC",
  "de": "Präzisions-Timer-IC",
  "fr": "Circuit minuterie de précision"
}
```

### Prisma-Schema Pattern

```prisma
model CoreComponent {
  // Lokalisierte Felder als JSON:
  name              Json    // LocalizedString - { "de": "...", "en": "..." }
  shortDescription  Json?   // LocalizedString (optional)
  fullDescription   Json?   // LocalizedString (optional)

  // Nicht lokalisiert (technische Werte):
  slug              String  @unique  // URL-slug bleibt einsprachig
}
```

### Fallback-Logik

```typescript
// packages/shared/src/i18n/localized-string.ts

export type Locale = 'en' | 'de' | 'fr' | 'es' | 'zh';
export const FALLBACK_LOCALE: Locale = 'en';
export const SUPPORTED_LOCALES: Locale[] = ['en', 'de', 'fr', 'es', 'zh'];

/**
 * Löst einen lokalisierten String auf mit Fallback-Kette:
 * 1. Angefragte Sprache
 * 2. Englisch (bevorzugter Fallback)
 * 3. Erste verfügbare Sprache
 */
export function t(
  localized: LocalizedString | null | undefined,
  locale: Locale
): string {
  if (!localized) return '';

  // 1. Versuche angefragte Sprache
  if (localized[locale]) {
    return localized[locale]!;
  }

  // 2. Fallback zu Englisch
  if (localized.en) {
    return localized.en;
  }

  // 3. Erste verfügbare Sprache
  for (const fallbackLocale of SUPPORTED_LOCALES) {
    if (localized[fallbackLocale]) {
      return localized[fallbackLocale]!;
    }
  }

  return '';
}
```

### Zod-Schema

```typescript
// packages/schemas/src/localized.schema.ts

import { z } from 'zod';

// Mindestens eine Sprache muss ausgefüllt sein
export const LocalizedStringSchema = z.object({
  en: z.string().optional(),
  de: z.string().optional(),
  fr: z.string().optional(),
  es: z.string().optional(),
  zh: z.string().optional(),
}).refine(
  data => Object.values(data).some(v => v && v.length > 0),
  { message: 'At least one language must be provided' }
);

// Für optionale lokalisierte Felder
export const OptionalLocalizedStringSchema = z.object({
  en: z.string().optional(),
  de: z.string().optional(),
  fr: z.string().optional(),
  es: z.string().optional(),
  zh: z.string().optional(),
}).optional().nullable();
```

---

## Betroffene Felder

### CoreComponent

| Feld | Lokalisiert | Begründung |
|------|-------------|------------|
| `name` | ✅ Ja | "Capacitor" vs "Kondensator" |
| `slug` | ❌ Nein | URL-Pfad, technisch |
| `shortDescription` | ✅ Ja | Nutzerbeschreibung |
| `fullDescription` | ✅ Ja | Ausführliche Beschreibung |
| `commonAttributes` | ❌ Nein | Technische Werte (JSON) |

### CategoryTaxonomy

| Feld | Lokalisiert | Begründung |
|------|-------------|------------|
| `name` | ✅ Ja | "Resistors" vs "Widerstände" |
| `slug` | ❌ Nein | URL-Pfad |
| `description` | ✅ Ja | Kategoriebeschreibung |

### AttributeDefinition

| Feld | Lokalisiert | Begründung |
|------|-------------|------------|
| `name` | ❌ Nein | Technischer Schlüssel ("capacitance") |
| `displayName` | ✅ Ja | "Capacitance" vs "Kapazität" |
| `unit` | ❌ Nein | SI-Einheiten sind universal ("F", "Ω") |

### ManufacturerMaster

| Feld | Lokalisiert | Begründung |
|------|-------------|------------|
| `name` | ❌ Nein | Firmenname ist universal |
| `description` | ✅ Ja | Beschreibung der Firma |

---

## API-Design

```typescript
// GET /api/components/:id
// Header: Accept-Language: de

// Response - Felder werden automatisch aufgelöst:
{
  "id": "...",
  "name": "Kondensator",              // Aufgelöst für "de"
  "name_locales": ["de", "en"],       // Verfügbare Sprachen
  "name_all": {                       // Alle Übersetzungen (für Edit-Modus)
    "de": "Kondensator",
    "en": "Capacitor"
  },
  "mpn": "CAP-100UF-25V"              // Nicht lokalisiert
}

// POST /api/components
// Body enthält LocalizedString-Objekte:
{
  "name": {
    "de": "Kondensator"    // Nur Deutsch - völlig OK!
  },
  "shortDescription": {
    "de": "Ein passives Bauelement",
    "en": "A passive electronic component"
  }
}
```

---

## UI-Internationalisierung

Für statische UI-Texte (Buttons, Labels, Fehlermeldungen) wird `next-intl` verwendet:

```
apps/web/
├── messages/
│   ├── en.json
│   ├── de.json
│   └── ...
└── i18n.ts
```

```json
// apps/web/messages/de.json
{
  "common": {
    "save": "Speichern",
    "cancel": "Abbrechen",
    "delete": "Löschen",
    "loading": "Lädt..."
  },
  "components": {
    "title": "Bauteile",
    "createNew": "Neues Bauteil erstellen",
    "noResults": "Keine Bauteile gefunden"
  },
  "i18n": {
    "fallbackNotice": "Anzeige in {locale}, da keine deutsche Übersetzung vorhanden",
    "addTranslation": "Übersetzung hinzufügen",
    "availableIn": "Verfügbar in: {locales}"
  }
}
```

---

*Siehe auch: [tech-stack.md](tech-stack.md) | [database-schema.md](database-schema.md)*
